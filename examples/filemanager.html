<html>
	<head>
		<title>authenticated file manager example</title>
	</head>
	<body>
		<h1>authenticated file manager example</h1>

			email:<input type="text" id="email">
			passphrase:<input type="text" id="passphrase">
			<input type="button" onclick="login()" value="login">

			<hr>

			path:<input type="text" id="path"><input type="button" onclick="load_files()" value="load">
			<br>
			files:<select multiple id="file_list"></select>
			<br>
			<input type="file" id="selected_file" value="upload"><input type="button" onclick="upload_file()" value="send">

		<script>

            // utility hash function
            function hashit(value) {
                var hash = 0, i, chr, len;
                if (value == 0) return hash;

                for (i = 0, len = value.length; i < len; i++) {
                    chr   = value.charCodeAt(i);
                    hash  = ((hash << 5) - hash) + chr;
                    hash |= 0; // Convert to 32bit integer
                }

                return hash;
            };

			// where to store keychains
			var keychain_root = "http://localhost:7302/keychains";	// remove the host when hosting this inside jsfs
			var keychain = null;

			function login(){

				// debug
				console.log("got login()");
				console.log("email: " + email.value);
				console.log("passphrase: " + passphrase.value);

				// use hashes of email and passphrase to access keychain 
				var hashed_email = hashit(email.value);
				var hashed_passphrase = hashit(passphrase.value);

				console.log("hashed_email: " + hashed_email);
				console.log("hashed_passphrase: " + hashed_passphrase);

				// try to load keychain
				var xhr = new XMLHttpRequest();
				xhr.open("GET", keychain_root + "/" + hashed_email, true);
				xhr.setRequestHeader("x-access-token", hashed_passphrase);
				xhr.onreadystatechange = parse_response;
				xhr.send();

				function parse_response(){
					if(this.readyState === 4){

						console.log("load keychain request status: " + this.status);

						if(this.status === 200){

							// sucess!
							keychain = JSON.parse(this.responseText);

							console.log("keychain with " + keychain.keys.length + " keys loaded");

							load_file_list();
 
						} else {

							// failure!
							console.log("unable to load keychain for these credentials, HTTP " + this.status);

							create_keychain();
						}
					}
				}

				// if keychain isn't found, create a new one
				function create_keychain(){

					console.log("got create_keychain()");

					keychain = {};
					keychain.keys = [];
					xhr.open("POST", keychain_root + "/" + hashed_email, true);
					xhr.setRequestHeader("x-access-token", hashed_passphrase);
					xhr.setRequestHeader("x-private", "true");
					xhr.setRequestHeader("x-encrypted", "true");
					xhr.onreadystatechange = parse_response;
					xhr.send(JSON.stringify(keychain));

					function parse_response(){
						if(this.readyState == 4){
							if(this.status === 200){
								console.log("keychain created");
							} else {
								console.log("keychain creation failed, HTTP " + this.status);
							}
						}
					}
				}
			}

			function load_file_list(){

				// debug
				console.log("got load_file_list()");

				// dump the current list
				file_list.innerHTML = null;

				// add each file from keychain to the file list
				for(key in keychain.keys){
					a_key = keychain.keys[key];
					var file_option = document.createElement("option");
					file_option.value = a_key.access_token;
					file_option.innerHTML = a_key.url;
					file_list.appendChild(file_option);
				}
			}

			function upload_file(){

				// debug
				console.log("got upload_file()");
				console.log(path.value + "/" + selected_file.files[0].name);

				var file = selected_file.files[0];

				// todo POST file to path
                var xhr = new XMLHttpRequest();
                xhr.open("POST", path.value + '/' + file.name, true);
                xhr.setRequestHeader("X_FILENAME", file.name);
                xhr.onreadystatechange = uploadStatus;
                xhr.send(file);
               
                function uploadStatus(){
                    if(this.readyState == 4){
						if(this.status === 200){
							
							console.log('done uploading ' + file.name);

							// extract access_token from response
							var post_result = JSON.parse(this.responseText);

							add_to_keychain(path.value + "/" + file.name, post_result.access_token);

						} else {
							console.log("Error saving file, HTTP " + this.status);
						}
                    }
                }

				function add_to_keychain(url, access_token){
					// add new key to keychain
					var new_key = {};
					new_key.access_token = access_token;
					new_key.url = url;
					keychain.keys.push(new_key);

					save_keychain();
				}

				function save_keychain(){
					// PUT keychain

					// use hashes of email and passphrase to access keychain 
					var hashed_email = hashit(email.value);
					var hashed_passphrase = hashit(passphrase.value);

					xhr.open("PUT", keychain_root + "/" + hashed_email, true);
                    xhr.setRequestHeader("x-access-token", hashed_passphrase);
                    xhr.setRequestHeader("x-private", "true");
                    xhr.setRequestHeader("x-encrypted", "true");
                    xhr.onreadystatechange = parse_response;
                    xhr.send(JSON.stringify(keychain));

                    function parse_response(){
                        if(this.readyState == 4){
                            if(this.status === 200){
                                console.log("keychain updated");

								// update file list
								load_file_list();

                            } else {
                                console.log("keychain update failed, HTTP " + this.status);
                            }
                        }
                    }
				}
			}

		</script>

	</body>
</html>
